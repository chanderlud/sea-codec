const t=(t,e=t=>void 0!==t?": "+t:"")=>class extends Error{origMessage;constructor(s){super(t(s)+e(s)),this.origMessage=void 0!==s?String(s):""}},e=t(()=>"illegal argument(s)"),s=t=>{throw new e(t)},i=t(()=>"illegal state");class r{buffer;start;limit;pos;bitPos;bit;constructor(t,e=0,s=t.length<<3){this.buffer=t,this.start=e,this.limit=s,this.seek(e)}*[Symbol.iterator](){let t=this.start,e=t>>>3,s=7-(7&t);for(;t<this.limit;)yield this.buffer[e]>>>s&1,--s<0&&(e++,s=7),t++}get length(){return this.limit}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.limit)&&s(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(7&t),this.bitPos=t,this}read(t=1,e=!0){if(t>32)return 4294967296*this.read(t-32,e)+this.read(32,e);if(t>8){let s=0,i=-8&t,r=t-i;for(r>0&&(s=this._read(r,e));i>0;)s=(s<<8|this._read(8,e))>>>0,i-=8;return s}return this._read(t,e)}readFields(t,e=!0){return t.map(t=>this.read(t,e))}readWords(t,e=8,s=!0){let i=[];for(;t-- >0;)i.push(this.read(e,s));return i}readStruct(t,e=!0){return t.reduce((t,[s,i])=>(t[s]=this.read(i,e),t),{})}readBit(t=!0){t&&this.checkLimit(1),this.bit--,this.bitPos++;let e=this.buffer[this.pos]>>>this.bit&1;return 0===this.bit&&(this.pos++,this.bit=8),e}_read(t,e=!0){e&&this.checkLimit(t);let s,i=this.bit-t;return i>=0?(this.bit=i,s=this.buffer[this.pos]>>>i&(1<<t)-1,0===i&&(this.pos++,this.bit=8)):(s=(this.buffer[this.pos++]&(1<<this.bit)-1)<<-i,this.bit=8+i,s|=this.buffer[this.pos]>>>this.bit),this.bitPos+=t,s}checkLimit(t){this.bitPos+t>this.limit&&(()=>{throw new i("can't read past EOF")})()}}const h=4294967296;class o{buffer;start;pos;bit;bitPos;constructor(t,e=0){this.buffer=void 0===t?new Uint8Array(16):"number"==typeof t?new Uint8Array(t):t,this.start=e,this.seek(e),this.buffer[this.pos]&=~((1<<this.bit)-1)}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.buffer.length<<3)&&s(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(7&t),this.bitPos=t,this}bytes(){return this.buffer.slice(0,this.pos+(7&this.bit?1:0))}reader(t=0){return new r(this.buffer,t,this.position)}write(t,e=1){if(e>32){let s=Math.floor(t/h);this.write(s,e-32),this.write(t-s*h,32)}else if(e>8){let s=-8&e,i=e-s;for(i>0&&this._write(t>>>s,i),s-=8;s>=0;)this._write(t>>>s,8),s-=8}else this._write(t,e);return this}writeWords(t,e=8){let s,i=t[Symbol.iterator]();for(;s=i.next(),!s.done;)this.write(s.value,e)}writeBit(t){return this.bit--,this.buffer[this.pos]=this.buffer[this.pos]&~(1<<this.bit)|t<<this.bit,0===this.bit&&(this.ensureSize(),this.bit=8),this.bitPos++,this}_write(t,e){t&=(1<<e)-1;let s=this.buffer,i=this.pos,r=this.bit,h=r-e,o=r<8?~((1<<r)-1):0;return h>=0?(o|=(1<<h)-1,s[i]=s[i]&o|t<<h&~o,0===h?(this.ensureSize(),this.bit=8):this.bit=h):(this.bit=r=8+h,s[i]=s[i]&o|t>>>-h&~o,this.ensureSize(),this.buffer[this.pos]=this.buffer[this.pos]&(1<<r)-1|t<<r&255),this.bitPos+=e,this}ensureSize(){if(++this.pos===this.buffer.length){let t=new Uint8Array(this.buffer.length<<1);t.set(this.buffer),this.buffer=t}}}const n=20,a=5120,l=1903124838;function f(t,e,s){return t<e?e:t>s?s:t}function u(t,e){return{history:new Int16Array(t||4),weights:new Int16Array(e||4)}}function b(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]>>13}function c(t,e,s,i){let r=i>>4;t[0]+=e[0]<0?-r:r,t[1]+=e[1]<0?-r:r,t[2]+=e[2]<0?-r:r,t[3]+=e[3]<0?-r:r,e[0]=e[1],e[1]=e[2],e[2]=e[3],e[3]=s}const w=t=>Math.sign(t)*Math.round(Math.abs(t)),d=Array(16).fill().map((t,e)=>w(Math.pow(e+1,2.75))),p=[.75,-.75,2.5,-2.5,4.5,-4.5,7,-7],g=d.map(t=>p.map(e=>w(e*t)));function m(t,e,s,i,r){const h=t.read(8),o=t.read(24),a=t.read(16),l=t.read(16),u=Math.floor(l-8-16*h),w=Math.floor(u/8);if(h!=e.channels||o!=e.sampleRate||a*h>w*n)throw new Error("invalid frame header data");for(let e=0;e<h;e++){const i=s[e];for(let e=0;e<4;e++){let s=t.read(16);i.history[e]=s}for(let e=0;e<4;e++){let s=t.read(16);i.weights[e]=s}}for(let e=0;e<a;e+=n)for(let o=0;o<h;o++){const h=t.read(4),l=g[h],u=e,w=Math.min(e+n,a)-u,d=s[o],p=i[o];let m=r+u;const y=d.weights,M=d.history;let k=60;for(let e=0;e<w;e++){const e=b(y,M),s=l[t.read(3)],i=f(e+s,-32768,32767);p[m++]=i<0?i/32768:i/32767,c(y,M,i,s),k-=3}k>0&&t.read(k)}return a}function y(t){if(t.byteLength<16)throw new Error("QOA file size must be >= 16");const e=new r(t),s=function(t){if(t.read(32)!==l)throw new Error("Not a QOA file; expected magic number 'qoaf'");const e={samples:t.read(32),channels:t.read(8),sampleRate:t.read(24)};return t.seek(64),e}(e),i=[],h=[];for(let t=0;t<s.channels;t++){const t=new Float32Array(s.samples);i.push(t),h.push(u())}let o=0,n=0;do{n=m(e,s,h,i,o),o+=n}while(n&&o<s.samples);return{...s,channelData:i}}const M=d.map(t=>Math.floor((65536+t-1)/t)),k=[7,7,7,5,5,3,3,1,0,0,2,2,4,4,6,6,6];function A(t,e){let s=t*M[e]+32768>>16;return s=s+((t>0)-(t<0))-((s>0)-(s<0)),s}function P(t,e,s,i,r){const h=e.channels,o=e.sampleRate,a=e.channelData,l=((t,e)=>Math.floor(8+16*t+8*e*t))(h,Math.floor((r+n-1)/n));t.write(h,8),t.write(o,24),t.write(r,16),t.write(l,16);for(let e=0;e<h;e++){const i=s[e];i.weights[0]*i.weights[0]+i.weights[1]*i.weights[1]+i.weights[2]*i.weights[2]+i.weights[3]*i.weights[3]>805306367&&(i.weights[0]=0,i.weights[1]=0,i.weights[2]=0,i.weights[3]=0);for(let e=0;e<4;e++)t.write(i.history[e],16);for(let e=0;e<4;e++)t.write(i.weights[e],16)}for(let e=0;e<r;e+=n)for(let o=0;o<h;o++){const h=f(n,0,r-e),l=e;let w,d,p,m=Number.MAX_SAFE_INTEGER;const y=a[o];for(let t=0;t<16;t++){let e=u(s[o].history,s[o].weights);const r=g[t];let n=[],a=0,M=l+i;for(let s=0;s<h;s++){let s=y[M++];s=Math.floor(Math.fround(s<0?32768*s:32767*s)),s=f(s,-32768,32767);let i=b(e.weights,e.history),h=f(A(s-i,t),-8,8),o=k[h+8],l=r[o],u=f(i+l,-32768,32767),w=s-u;if(a+=w*w,a>m)break;c(e.weights,e.history,u,l),n.push(o)}a<m&&(m=a,w=n,d=t,p=e)}s[o]=p,t.write(d,4);for(let e=0;e<n;e++)t.write(e<w.length?w[e]:0,3)}}function _({channelData:t,sampleRate:e=44100}={}){const s=t.length,i=s>=1?t[0].length:0,r={samples:i,channels:s,channelData:t,sampleRate:e},h=(i+a-1)/a,b=8+8*h+4*h*4*r.channels+(i+n-1)/n*8*r.channels,c=[];for(let t=0;t<r.channels;t++){const t=u();t.weights[0]=0,t.weights[1]=0,t.weights[2]=-8192,t.weights[3]=16384,c.push(t)}const w=new o(b);w.write(l,32),w.write(i,32);let d=a;for(let t=0;t<i;t+=d)d=f(a,0,i-t),P(w,r,c,t,d);return w.bytes()}export{y as decode,_ as encode};
//# sourceMappingURL=index-99d7c744.js.map
